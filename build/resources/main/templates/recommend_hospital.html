<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>응급 병원 추천 시스템</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Naver Maps API - clientId를 Thymeleaf 변수로 전달 -->
    <script th:src="@{https://openapi.map.naver.com/openapi/v3/maps.js(ncpClientId=${naverClientId})}"></script>

    <!-- Custom CSS -->
    <style>
        body {
            background-color: #f8f9fa;
        }
        h1, h2 {
            color: #007bff;
        }
        .summary-container {
            background: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .hospital-table th {
            background-color: #007bff;
            color: #ffffff;
        }

        #map= {
            width: 100%;
            height: 400px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h1 class="text-center">응급 병원 추천 결과</h1>

    <!-- 요약 정보 -->
    <div class="summary-container mt-4">
        <h2>Summary</h2>
        <p><strong>요약:</strong> <span th:text="${summary}"></span></p>
        <h3>키워드:</h3>
        <ul class="list-group">
            <li class="list-group-item" th:each="keyword : ${keywords}" th:text="${keyword}"></li>
        </ul>
        <h2 class="mt-3">위험도</h2>
        <p class="badge bg-danger" th:text="'위험등급: ' + ${dangerLevel}"></p>
    </div>

    <!-- 병원 리스트 -->
    <div class="mt-5">
        <h2>추천 병원 리스트</h2>
        <!-- 병원 리스트 테이블 수정 -->
        <table class="table table-striped table-hover hospital-table">
            <thead>
            <tr>
                <th>병원 이름</th>
                <th>주소</th>
                <th>거리 (km)</th>
                <th>전화번호</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="hospital, stat : ${hospitals}"
                th:data-lat="${hospital.hospitalLatitude}"
                th:data-lng="${hospital.hospitalLongitude}"
                th:onclick="'updateRoute(' + ${hospital.hospitalLatitude} + ',' + ${hospital.hospitalLongitude} + ')'"
                style="cursor: pointer">
                <td th:text="${hospital.hospitalName}"></td>
                <td th:text="${hospital.address}"></td>
                <td th:text="${hospital.distanceKm}"></td>
                <td th:text="${hospital.phone1}"></td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

    <!-- 네이버 지도 -->
    <div id="map" style="width:100%;height:400px;margin:20px 0 60px 0;"></div>
</div>

<!-- 지도 스크립트 수정 -->
<script th:inline="javascript">
    let map, currentPolyline, startMarker, endMarker;
    const userLat = /*[[${userLatitude}]]*/ 0;
    const userLng = /*[[${userLongitude}]]*/ 0;
    const navigationData = /*[[${navigationData}]]*/ null;

    function initMap() {
        const mapOptions = {
            center: new naver.maps.LatLng(userLat, userLng),
            zoom: 13
        };
        map = new naver.maps.Map('map', mapOptions);
        displayInitialRoute();
    }

    function createMarker(position, isStart) {
        return new naver.maps.Marker({
            position: position,
            map: map,
            icon: {
                content: `
                    <div style="position:relative;">
                        <div style="position:absolute;top:-42px;left:-13px;">
                            <img src="https://ssl.pstatic.net/static/maps/m/pin_default.png" style="width:27px;height:42px;">
                            <div style="position:absolute;top:6px;left:4px;width:19px;height:19px;background:${isStart ? '#03c75a' : '#f23d3d'};border-radius:50%;display:flex;align-items:center;justify-content:center;">
                                <span style="color:white;font-size:12px;font-weight:bold;">${isStart ? '출' : '도'}</span>
                            </div>
                        </div>
                    </div>
                `,
                anchor: new naver.maps.Point(13.5, 42) // 정확한 중심 위치로 조정
            }
        });
    }

    async function updateRoute(hospitalLat, hospitalLng) {
        try {
            const response = await fetch(`/api/navigation?fromLat=${userLat}&fromLng=${userLng}&toLat=${hospitalLat}&toLng=${hospitalLng}`);
            const newNavigationData = await response.json();

            // 기존 경로와 마커 제거
            if (currentPolyline) currentPolyline.setMap(null);
            if (startMarker) startMarker.setMap(null);
            if (endMarker) endMarker.setMap(null);

            const pathCoords = newNavigationData.route.traoptimal[0].path.map(coord =>
                new naver.maps.LatLng(coord[1], coord[0])
            );

            // 새 마커 생성
            startMarker = createMarker(pathCoords[0], true);
            endMarker = createMarker(pathCoords[pathCoords.length - 1], false);

            // 새 경로 그리기
            currentPolyline = new naver.maps.Polyline({
                path: pathCoords,
                strokeColor: '#03c75a',
                strokeWeight: 5,
                strokeOpacity: 0.8,
                map: map
            });

            // 경로가 모두 보이도록 지도 범위 조정
            const bounds = pathCoords.reduce((bounds, latlng) =>
                bounds.extend(latlng), new naver.maps.LatLngBounds()
            );
            map.fitBounds(bounds, { top: 50, bottom: 50, left: 50, right: 50 });
        } catch (error) {
            console.error('경로 업데이트 중 오류 발생:', error);
        }
    }

    function displayInitialRoute() {
        const parsedData = typeof navigationData === 'string'
            ? JSON.parse(navigationData)
            : navigationData;

        if (parsedData?.route?.traoptimal?.[0]?.path) {
            const pathCoords = parsedData.route.traoptimal[0].path.map(coord =>
                new naver.maps.LatLng(coord[1], coord[0])
            );

            startMarker = createMarker(pathCoords[0], true);
            endMarker = createMarker(pathCoords[pathCoords.length - 1], false);

            currentPolyline = new naver.maps.Polyline({
                path: pathCoords,
                strokeColor: '#03c75a',
                strokeWeight: 5,
                strokeOpacity: 0.8,
                map: map
            });

            const bounds = pathCoords.reduce((bounds, latlng) =>
                bounds.extend(latlng), new naver.maps.LatLngBounds()
            );
            map.fitBounds(bounds);
        }
    }

    // 지도 초기화
    window.addEventListener('load', initMap);
</script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
